name: Auto-Update from Equicord

on:
  schedule:
    # ExÃ©cute tous les jours Ã  2h du matin UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Permet l'exÃ©cution manuelle
    inputs:
      force_update:
        description: 'Forcer la mise Ã  jour mÃªme si pas de nouveaux commits'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Bashcord repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name "Bashcord Auto-Updater"
        git config --global user.email "bashcord@auto-updater.local"

    - name: Add Equicord remote
      run: |
        if ! git remote | grep -q "equicord"; then
          git remote add equicord https://github.com/Equicord/Equicord.git
        fi

    - name: Fetch latest from Equicord
      run: |
        git fetch equicord

    - name: Check for new commits
      id: check_commits
      run: |
        # VÃ©rifier s'il y a de nouveaux commits
        NEW_COMMITS=$(git rev-list --count HEAD..equicord/main)
        echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$NEW_COMMITS" -gt 0 ]; then
          echo "has_new_commits=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¥ $NEW_COMMITS nouveaux commits trouvÃ©s dans Equicord"
        else
          echo "has_new_commits=false" >> $GITHUB_OUTPUT
          echo "âœ… Aucun nouveau commit dans Equicord"
        fi

    - name: Backup protected files
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸ’¾ Sauvegarde des fichiers personnalisÃ©s Bashcord..."
        
        # CrÃ©er un dossier de sauvegarde
        mkdir -p backup_bashcord_customizations
        
        # Fichiers et dossiers Ã  protÃ©ger
        PROTECTED_FILES=(
          "src/plugins/_core/settings.tsx"
          "src/bashplugins"
          "src/components/WelcomeModal.tsx"
        )
        
        # Sauvegarder chaque fichier protÃ©gÃ©
        for file in "${PROTECTED_FILES[@]}"; do
          if [ -e "$file" ]; then
            cp -r "$file" "backup_bashcord_customizations/"
            echo "âœ… SauvegardÃ©: $file"
          else
            echo "âš ï¸ Fichier non trouvÃ©: $file"
          fi
        done
        
        # VÃ©rifier que les sauvegardes sont correctes
        if [ -f "backup_bashcord_customizations/settings.tsx" ] && grep -q "Bashcord" "backup_bashcord_customizations/settings.tsx"; then
          echo "âœ… Sauvegarde settings.tsx validÃ©e"
        else
          echo "âŒ Erreur: Sauvegarde settings.tsx invalide"
          exit 1
        fi
        
        if [ -d "backup_bashcord_customizations/bashplugins" ] && [ "$(ls -A backup_bashcord_customizations/bashplugins)" ]; then
          plugin_count=$(find backup_bashcord_customizations/bashplugins -name "*.tsx" -o -name "*.ts" | wc -l)
          echo "âœ… Sauvegarde bashplugins validÃ©e ($plugin_count plugins)"
        else
          echo "âŒ Erreur: Sauvegarde bashplugins invalide"
          exit 1
        fi
        
        if [ -f "backup_bashcord_customizations/WelcomeModal.tsx" ] && grep -q "Bashcord" "backup_bashcord_customizations/WelcomeModal.tsx"; then
          echo "âœ… Sauvegarde WelcomeModal.tsx validÃ©e"
        else
          echo "âŒ Erreur: Sauvegarde WelcomeModal.tsx invalide"
          exit 1
        fi

    - name: Merge from Equicord
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸ”„ Fusion des modifications d'Equicord..."
        
        # Tenter la fusion automatique
        if git merge equicord/main --no-commit; then
          echo "âœ… Fusion automatique rÃ©ussie"
        else
          echo "âš ï¸ Conflits dÃ©tectÃ©s, rÃ©solution automatique..."
          
          # RÃ©soudre les conflits pour les fichiers protÃ©gÃ©s
          PROTECTED_FILES=(
            "src/plugins/_core/settings.tsx"
            "src/bashplugins"
            "src/components/WelcomeModal.tsx"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            if git status --porcelain | grep -q "$file"; then
              echo "ðŸ”§ RÃ©solution du conflit pour: $file (garde notre version)"
              git checkout --ours "$file" 2>/dev/null || true
            fi
          done
          
          # Accepter les autres modifications d'Equicord
          git add . 2>/dev/null || true
        fi

    - name: Restore protected files
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸ”„ Restauration des fichiers personnalisÃ©s Bashcord..."
        
        # Restaurer les fichiers protÃ©gÃ©s
        PROTECTED_FILES=(
          "src/plugins/_core/settings.tsx"
          "src/bashplugins"
          "src/components/WelcomeModal.tsx"
        )
        
        for file in "${PROTECTED_FILES[@]}"; do
          backup_file="backup_bashcord_customizations/$(basename "$file")"
          if [ -e "$backup_file" ]; then
            # CrÃ©er le dossier parent si nÃ©cessaire
            mkdir -p "$(dirname "$file")"
            cp -r "$backup_file" "$file"
            echo "âœ… RestaurÃ©: $file"
          fi
        done

    - name: Verify customizations
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸ” VÃ©rification des personnalisations Bashcord..."
        
        # VÃ©rifier settings.tsx
        if grep -q "Bashcord" src/plugins/_core/settings.tsx; then
          echo "âœ… Personnalisations Bashcord prÃ©servÃ©es dans settings.tsx"
        else
          echo "âŒ Erreur: Personnalisations Bashcord manquantes dans settings.tsx!"
          exit 1
        fi
        
        # VÃ©rifier bashplugins
        if [ -d "src/bashplugins" ] && [ "$(ls -A src/bashplugins)" ]; then
          plugin_count=$(find src/bashplugins -name "*.tsx" -o -name "*.ts" | wc -l)
          echo "âœ… Dossier bashplugins prÃ©servÃ© avec $plugin_count plugins"
        else
          echo "âš ï¸ Dossier bashplugins manquant, crÃ©ation..."
          mkdir -p src/bashplugins
          if [ -d "backup_bashcord_customizations/bashplugins" ]; then
            cp -r backup_bashcord_customizations/bashplugins/* src/bashplugins/
            plugin_count=$(find src/bashplugins -name "*.tsx" -o -name "*.ts" | wc -l)
            echo "âœ… Dossier bashplugins restaurÃ© avec $plugin_count plugins"
          else
            echo "âŒ Erreur: Sauvegarde bashplugins introuvable!"
            exit 1
          fi
        fi
        
        # VÃ©rifier WelcomeModal.tsx
        if [ -f "src/components/WelcomeModal.tsx" ] && grep -q "Bashcord" src/components/WelcomeModal.tsx; then
          echo "âœ… WelcomeModal.tsx prÃ©servÃ©"
        else
          echo "âŒ Erreur: WelcomeModal.tsx manquant ou invalide!"
          exit 1
        fi

    - name: Commit changes
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸ’¾ Finalisation de la mise Ã  jour..."
        
        # Ajouter tous les changements
        git add .
        
        # CrÃ©er le message de commit
        COMMIT_MSG="ðŸ¤– Auto-update from Equicord $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ðŸ“¥ IntÃ©gration de ${{ steps.check_commits.outputs.new_commits }} nouveaux commits d'Equicord
        ðŸ›¡ï¸ Protection des personnalisations Bashcord:
          â€¢ src/plugins/_core/settings.tsx (interface Bashcord)
          â€¢ src/bashplugins/ (plugins personnalisÃ©s)
          â€¢ src/components/WelcomeModal.tsx (popup de bienvenue)
        
        ðŸ”— Source: https://github.com/Equicord/Equicord"
        
        # Commiter les changements
        git commit -m "$COMMIT_MSG"
        
        echo "âœ… Commit crÃ©Ã© avec succÃ¨s"

    - name: Push changes
      if: steps.check_commits.outputs.has_new_commits == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "ðŸš€ Envoi des modifications..."
        git push origin main
        
        echo "âœ… Modifications envoyÃ©es avec succÃ¨s"

    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ“Š RÃ©sumÃ© de la mise Ã  jour automatique" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_commits.outputs.has_new_commits }}" == "true" ]; then
          echo "âœ… **Mise Ã  jour effectuÃ©e**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ ${{ steps.check_commits.outputs.new_commits }} nouveaux commits intÃ©grÃ©s d'Equicord" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Personnalisations Bashcord protÃ©gÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Fusion automatique rÃ©ussie" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Aucune mise Ã  jour nÃ©cessaire**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bashcord est dÃ©jÃ  Ã  jour avec Equicord" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ›¡ï¸ Fichiers protÃ©gÃ©s:" >> $GITHUB_STEP_SUMMARY
        echo "- \`src/plugins/_core/settings.tsx\` (interface Bashcord)" >> $GITHUB_STEP_SUMMARY
        echo "- \`src/bashplugins/\` (plugins personnalisÃ©s)" >> $GITHUB_STEP_SUMMARY
        echo "- \`src/components/WelcomeModal.tsx\` (popup de bienvenue)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Liens utiles:" >> $GITHUB_STEP_SUMMARY
        echo "- [Repository Equicord](https://github.com/Equicord/Equicord)" >> $GITHUB_STEP_SUMMARY
        echo "- [Commits rÃ©cents d'Equicord](https://github.com/Equicord/Equicord/commits/main)" >> $GITHUB_STEP_SUMMARY
