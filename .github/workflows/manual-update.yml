name: Manual Update from Equicord

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forcer la mise Ã  jour mÃªme si pas de nouveaux commits'
        required: false
        default: 'false'
        type: boolean
      update_message:
        description: 'Message personnalisÃ© pour le commit'
        required: false
        default: 'Manual update triggered'
        type: string

jobs:
  manual-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Bashcord repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config --global user.name "Bashcord Manual-Updater"
        git config --global user.email "bashcord@manual-updater.local"

    - name: Add Equicord remote
      run: |
        if ! git remote | grep -q "equicord"; then
          git remote add equicord https://github.com/Equicord/Equicord.git
        fi

    - name: Fetch latest from Equicord
      run: |
        git fetch equicord

    - name: Check for new commits
      id: check_commits
      run: |
        NEW_COMMITS=$(git rev-list --count HEAD..equicord/main)
        echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT
        
        if [ "$NEW_COMMITS" -gt 0 ] || [ "${{ github.event.inputs.force_update }}" == "true" ]; then
          echo "has_new_commits=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¥ $NEW_COMMITS nouveaux commits trouvÃ©s dans Equicord"
        else
          echo "has_new_commits=false" >> $GITHUB_OUTPUT
          echo "âœ… Aucun nouveau commit dans Equicord"
        fi

    - name: Backup protected files
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸ’¾ Sauvegarde des fichiers personnalisÃ©s Bashcord..."
        
        mkdir -p backup_bashcord_customizations
        
        PROTECTED_FILES=(
          "src/plugins/_core/settings.tsx"
          "src/userplugins"
        )
        
        for file in "${PROTECTED_FILES[@]}"; do
          if [ -e "$file" ]; then
            cp -r "$file" "backup_bashcord_customizations/"
            echo "âœ… SauvegardÃ©: $file"
          fi
        done

    - name: Merge from Equicord
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸ”„ Fusion des modifications d'Equicord..."
        
        if git merge equicord/main --no-commit; then
          echo "âœ… Fusion automatique rÃ©ussie"
        else
          echo "âš ï¸ Conflits dÃ©tectÃ©s, rÃ©solution automatique..."
          
          PROTECTED_FILES=(
            "src/plugins/_core/settings.tsx"
            "src/userplugins"
          )
          
          for file in "${PROTECTED_FILES[@]}"; do
            if git status --porcelain | grep -q "$file"; then
              echo "ðŸ”§ RÃ©solution du conflit pour: $file (garde notre version)"
              git checkout --ours "$file" 2>/dev/null || true
            fi
          done
          
          git add . 2>/dev/null || true
        fi

    - name: Restore protected files
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸ”„ Restauration des fichiers personnalisÃ©s Bashcord..."
        
        PROTECTED_FILES=(
          "src/plugins/_core/settings.tsx"
          "src/userplugins"
        )
        
        for file in "${PROTECTED_FILES[@]}"; do
          backup_file="backup_bashcord_customizations/$(basename "$file")"
          if [ -e "$backup_file" ]; then
            cp -r "$backup_file" "$file"
            echo "âœ… RestaurÃ©: $file"
          fi
        done

    - name: Verify customizations
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸ” VÃ©rification des personnalisations Bashcord..."
        
        if grep -q "Bashcord" src/plugins/_core/settings.tsx; then
          echo "âœ… Personnalisations Bashcord prÃ©servÃ©es dans settings.tsx"
        else
          echo "âŒ Erreur: Personnalisations Bashcord manquantes dans settings.tsx!"
          exit 1
        fi
        
        if [ -d "src/userplugins" ] && [ "$(ls -A src/userplugins)" ]; then
          plugin_count=$(find src/userplugins -name "*.tsx" -o -name "*.ts" | wc -l)
          echo "âœ… Dossier userplugins prÃ©servÃ© avec $plugin_count plugins"
        else
          echo "âŒ Erreur: Dossier userplugins manquant ou vide!"
          exit 1
        fi

    - name: Commit changes
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸ’¾ Finalisation de la mise Ã  jour..."
        
        git add .
        
        COMMIT_MSG="ðŸ¤– Manual update from Equicord $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ðŸ“¥ IntÃ©gration de ${{ steps.check_commits.outputs.new_commits }} nouveaux commits d'Equicord
        ðŸ›¡ï¸ Protection des personnalisations Bashcord
        
        ðŸ’¬ Message: ${{ github.event.inputs.update_message }}"
        
        git commit -m "$COMMIT_MSG"
        echo "âœ… Commit crÃ©Ã© avec succÃ¨s"

    - name: Push changes
      if: steps.check_commits.outputs.has_new_commits == 'true'
      run: |
        echo "ðŸš€ Envoi des modifications..."
        git push origin main
        echo "âœ… Modifications envoyÃ©es avec succÃ¨s"

    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ“Š RÃ©sumÃ© de la mise Ã  jour manuelle" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_commits.outputs.has_new_commits }}" == "true" ]; then
          echo "âœ… **Mise Ã  jour effectuÃ©e**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ ${{ steps.check_commits.outputs.new_commits }} nouveaux commits intÃ©grÃ©s d'Equicord" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Personnalisations Bashcord protÃ©gÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¬ Message: ${{ github.event.inputs.update_message }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Aucune mise Ã  jour nÃ©cessaire**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bashcord est dÃ©jÃ  Ã  jour avec Equicord" >> $GITHUB_STEP_SUMMARY
        fi
