name: Build Bashcord

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet l'exécution manuelle

env:
  FORCE_COLOR: true

jobs:
  build:
    name: Build Bashcord
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Bashcord
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PNPM
      uses: pnpm/action-setup@v3

    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "pnpm"

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build web version
      run: pnpm buildWeb

    - name: Build standalone version
      run: pnpm build

    - name: Generate plugin lists
      run: |
        pnpm generatePluginJson dist/plugins.json
        pnpm generateEquicordPluginJson dist/equicordplugins.json
        pnpm generateVencordPluginJson dist/vencordplugins.json
        pnpm generateDevsList dist/devs.json

    - name: Verify Bashcord customizations
      run: |
        echo "🔍 Vérification des personnalisations Bashcord..."
        
        # Vérifier que les personnalisations sont présentes
        if grep -q "Bashcord" src/plugins/_core/settings.tsx; then
          echo "✅ Personnalisations Bashcord présentes dans settings.tsx"
        else
          echo "❌ Erreur: Personnalisations Bashcord manquantes!"
          exit 1
        fi
        
        # Vérifier que le dossier userplugins existe
        if [ -d "src/userplugins" ] && [ "$(ls -A src/userplugins)" ]; then
          plugin_count=$(find src/userplugins -name "*.tsx" -o -name "*.ts" | wc -l)
          echo "✅ Dossier userplugins présent avec $plugin_count plugins"
        else
          echo "❌ Erreur: Dossier userplugins manquant ou vide!"
          exit 1
        fi

    - name: Create build summary
      run: |
        echo "## 🎉 Build Bashcord réussi" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Compilation réussie**" >> $GITHUB_STEP_SUMMARY
        echo "- 🌐 Version web compilée" >> $GITHUB_STEP_SUMMARY
        echo "- 📦 Version standalone compilée" >> $GITHUB_STEP_SUMMARY
        echo "- 📋 Listes de plugins générées" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🛡️ **Personnalisations Bashcord vérifiées**" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Interface Bashcord préservée" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Plugins personnalisés préservés" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📁 **Fichiers générés dans** \`dist/\`" >> $GITHUB_STEP_SUMMARY
