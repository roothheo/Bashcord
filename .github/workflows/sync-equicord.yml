name: ðŸ”„ Sync with Equicord

on:
  # Synchronisation automatique toutes les heures
  schedule:
    - cron: '0 * * * *'  # Toutes les heures

  # Permet de dÃ©clencher manuellement
  workflow_dispatch:

  # Se dÃ©clenche quand Equicord push de nouveaux commits
  repository_dispatch:
    types: [equicord-update]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout bashcord
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique

      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "Bashcord Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”— Add Equicord upstream
        run: |
          git remote add upstream https://github.com/Equicord/Equicord.git || true
          git fetch upstream

      - name: ðŸ“Š Check for updates
        id: check
        run: |
          CHANGES=$(git log --oneline HEAD..upstream/main | wc -l)
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT

          if [ "$CHANGES" -gt 0 ]; then
            echo "âœ… $CHANGES nouveau(x) commit(s) disponible(s)"
            git log --oneline HEAD..upstream/main | head -10
          else
            echo "âœ… DÃ©jÃ  Ã  jour avec Equicord"
          fi

      - name: ðŸ”€ Merge Equicord changes
        if: steps.check.outputs.changes > 0
        run: |
          echo "ðŸ”€ Merge en cours (fichiers protÃ©gÃ©s prÃ©servÃ©s)..."

          # Tenter le merge
          if git merge upstream/main --no-edit; then
            echo "âœ… Merge rÃ©ussi sans conflit"
          else
            echo "âš ï¸  Conflits dÃ©tectÃ©s, rÃ©solution automatique..."

            # Garder nos versions des fichiers protÃ©gÃ©s
            git checkout --ours src/userplugins/ || true
            git checkout --ours src/equicordplugins/followVoiceUser/ || true
            git checkout --ours src/components/settings/tabs/plugins/index.tsx || true

            # Marquer les conflits comme rÃ©solus
            git add .
            git merge --continue --no-edit || true

            echo "âœ… Conflits rÃ©solus"
          fi

      - name: ðŸ“¤ Push changes
        if: steps.check.outputs.changes > 0
        run: |
          git push origin main
          echo "âœ… Changements poussÃ©s vers bashcord"

      - name: ðŸ“ Create sync summary
        if: steps.check.outputs.changes > 0
        run: |
          echo "### ðŸŽ‰ Synchronisation rÃ©ussie" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commits mergÃ©s :** ${{ steps.check.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fichiers protÃ©gÃ©s :**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… src/userplugins/**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… src/equicordplugins/followVoiceUser/**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… src/components/settings/tabs/plugins/index.tsx" >> $GITHUB_STEP_SUMMARY

      - name: âœ… No changes
        if: steps.check.outputs.changes == 0
        run: |
          echo "### âœ… DÃ©jÃ  Ã  jour" >> $GITHUB_STEP_SUMMARY
          echo "Aucune mise Ã  jour disponible depuis Equicord" >> $GITHUB_STEP_SUMMARY
