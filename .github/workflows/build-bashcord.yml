name: Build Bashcord

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet l'exÃ©cution manuelle

env:
  FORCE_COLOR: true

jobs:
  build:
    name: Build Bashcord
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Bashcord
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PNPM
      uses: pnpm/action-setup@v3

    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "pnpm"

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build web version
      run: pnpm buildWeb

    - name: Build standalone version
      run: pnpm build

    - name: Generate plugin lists
      run: |
        pnpm generatePluginJson dist/plugins.json
        pnpm generateEquicordPluginJson dist/equicordplugins.json
        pnpm generateVencordPluginJson dist/vencordplugins.json
        pnpm generateDevsList dist/devs.json

    - name: Verify Bashcord customizations
      run: |
        echo "ðŸ” VÃ©rification des personnalisations Bashcord..."
        
        # VÃ©rifier que les personnalisations sont prÃ©sentes
        if grep -q "Bashcord" src/plugins/_core/settings.tsx; then
          echo "âœ… Personnalisations Bashcord prÃ©sentes dans settings.tsx"
        else
          echo "âŒ Erreur: Personnalisations Bashcord manquantes!"
          exit 1
        fi
        
        # VÃ©rifier que le dossier userplugins existe
        if [ -d "src/userplugins" ] && [ "$(ls -A src/userplugins)" ]; then
          plugin_count=$(find src/userplugins -name "*.tsx" -o -name "*.ts" | wc -l)
          echo "âœ… Dossier userplugins prÃ©sent avec $plugin_count plugins"
        else
          echo "âŒ Erreur: Dossier userplugins manquant ou vide!"
          exit 1
        fi

    - name: Create build summary
      run: |
        echo "## ðŸŽ‰ Build Bashcord rÃ©ussi" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Compilation rÃ©ussie**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Version web compilÃ©e" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Version standalone compilÃ©e" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ Listes de plugins gÃ©nÃ©rÃ©es" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ›¡ï¸ **Personnalisations Bashcord vÃ©rifiÃ©es**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Interface Bashcord prÃ©servÃ©e" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Plugins personnalisÃ©s prÃ©servÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Fichiers gÃ©nÃ©rÃ©s dans** \`dist/\`" >> $GITHUB_STEP_SUMMARY
